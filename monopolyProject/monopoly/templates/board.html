{% extends "base.html" %}
{% load i18n %}
{% block "body" %}
 
<!--<div class="bottom-toolbar">
    <div class="toolbar-content"> 
        <h1>
        CENG 445 Online Monopoly Demo 
        </h1>
        <div class="spacer"></div>
        {% if request.user.is_authenticated %}
            <div class="dropdown">
                <button type="button" class="toolbar-button" onclick="toggleDropdown()">
                    <span class="material-symbols-outlined" style="font-size: 40px;">
                        account_circle
                    </span>
                </button>
                <div class="dropdown-content" id="dropdownContent">
                    <a> username: {{ request.user.username }} </a>
                    <a> email: {{ request.user.email }} </a>
                    <a> full name: {{ request.user.full_name }} </a>
                    <hr>
                    <a href="/logout"> logout </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>-->

<h2> Board: {{ board_name }}</h2>
<a href="/board/{{ board_name }}/close">Close</a>
<a href="/board/{{ board_name }}/ready">Ready</a>
<a href="/board/{{ board_name }}/refresh">Refresh</a>


<form class="command" method="post" action="/board/{{ board_name }}/command/" >
    {% csrf_token %} 
    {{ command_form.as_p }}

    <input type="submit" value="{% trans 'Send' %}" />
    <input type="hidden" name="next" value="{{ next }}" />
</form>

<div style="display: flex;">
    <div style="overflow-x: scroll; position: relative;">
        <svg class="board" viewBox="0 0 1000 1000" width="100%" height="100%" >
            <rect x="0%" y="0%" width="100%" height="100%" fill=#bfdbae stroke="black" stroke-width="2"></rect>
            <text x="50%" y="50%" text-anchor="middle" fill="#000000" font-size="28px">  {{ board_name }} </text>
            {% for cell in board_status.cells %}
                {% if cell.type == 'property' %}
                    <rect x="{{ cell.x }}%" y="{{ cell.y }}%" width="{{ cell.w }}%" height="{{ cell.h }}%" fill="white", stroke="black", stroke-width=2 class="test-svg"  ></rect>
                    <rect x="{{ cell.x}}%" y="{{ cell.y }}%" width="{{ cell.w }}%" height="{{ cell.ch }}%" fill="{{ cell.color }}", stroke="black", stroke-width=1 ></rect>
                    <text x="{{ cell.namex }}%" y="{{ cell.namey }}%" text-anchor="middle" fill="#000000" font-size="14px">{{ cell.name }}</text>
                    <text x="{{ cell.pricex }}%" y="{{ cell.pricey }}%" text-anchor="middle" fill="#000000" font-size="14px">{{ cell.price }}$</text>
                    {% if cell.owner %}
                        <text x="{{ cell.ownerx }}%" y="{{ cell.ownery }}%" text-anchor="middle" fill="#000000" font-size="10px">{{ cell.owner }}</text>
                        <text x="{{ cell.levelx }}%" y="{{ cell.levely }}%" text-anchor="middle" fill="#000000" font-size="10px">{{ cell.level }}</text>
                    {% endif %}
                {% elif cell.type == 'tax' %}
                    <rect x="{{ cell.x }}%" y="{{ cell.y }}%" width="{{ cell.w }}%" height="{{ cell.h }}%" fill="red", stroke="black", stroke-width=2></rect>
                    <text x="{{ cell.namex }}%" y="{{ cell.namey }}%" text-anchor="middle" fill="#000000" font-size="14px">TAX</text>
                {% elif cell.type == 'goto jail' %}
                    <rect x="{{ cell.x }}%" y="{{ cell.y }}%" width="{{ cell.w }}%" height="{{ cell.h }}%" fill="brown" , stroke="black", stroke-width=2></rect>
                    <text x="{{ cell.namex }}%" y="{{ cell.namey }}%" text-anchor="middle" fill="#000000" font-size="14px">GO TO JAIL</text>
                {% elif cell.type == 'teleport' %}
                    <rect x="{{ cell.x }}%" y="{{ cell.y }}%" width="{{ cell.w }}%" height="{{ cell.h }}%" fill="purple", stroke="black", stroke-width=2></rect>
                    <text x="{{ cell.namex }}%" y="{{ cell.namey }}%" text-anchor="middle" fill="#000000" font-size="14px">TELEPORT</text>
                {% elif cell.type == 'jail' %}
                    <rect x="{{ cell.x }}%" y="{{ cell.y }}%" width="{{ cell.w }}%" height="{{ cell.h }}%" fill="brown", stroke="black", stroke-width=2></rect>
                    <text x="{{ cell.namex }}%" y="{{ cell.namey }}%" text-anchor="middle" fill="#000000" font-size="14px">JAIL</text>
                {% elif cell.type == 'chance card' %}
                    <rect x="{{ cell.x }}%" y="{{ cell.y }}%" width="{{ cell.w }}%" height="{{ cell.h }}%" fill="orange", stroke="black", stroke-width=2></rect>
                    <text x="{{ cell.namex }}%" y="{{ cell.namey }}%" text-anchor="middle" fill="#000000" font-size="14px">CHANCE</text>
                {% elif cell.type == 'lottery' %}
                    <rect x="{{ cell.x }}%" y="{{ cell.y }}%" width="{{ cell.w }}%" height="{{ cell.h }}%" fill="green", stroke="black", stroke-width=2></rect>
                    <text x="{{ cell.namex }}%" y="{{ cell.namey }}%" text-anchor="middle" fill="#000000" font-size="14px">LOTTERY</text>
                {% elif cell.type == 'start' %}
                    <rect x="{{ cell.x }}%" y="{{ cell.y }}%" width="{{ cell.w }}%" height="{{ cell.h }}%" fill="beige", stroke="black", stroke-width=2></rect>
                    <text x="{{ cell.namex }}%" y="{{ cell.namey }}%" text-anchor="middle" fill="#000000" font-size="14px">START</text>
                {% endif %}
                {% for user in board_status.users %}
                    {% if user.location == cell.number %}
                        <rect x="{{ cell.userx }}%" y="{{ cell.usery }}%" width="{{ cell.userw }}%" height="{{ cell.userh }}%" fill="beige", stroke="black", stroke-width=2></rect>
                        <text x="{{ cell.tagx }}%" y="{{ cell.tagy }}%" text-anchor="middle" fill="black" font-size="12px" >{{ user.username }}</text>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </svg>
        {% for cell in board_status.cells %}
            {% if cell.type == 'property' %}
                <button 
                style="position: absolute; top: {{cell.y}}% ; left: {{cell.x}}%; width:{{cell.w}}%; height:{{ cell.h }}% ; opacity: 0.1;" onclick="pickButtonHandler({{cell.number}})()">
                </button>
            {% endif %}
            {% if cell.number == 7 %}
                <img src="/static/images/monopoly.svg" id="monopoly" style="position: absolute; top: 38%; left: 30%; width: 40%; height: 11.1%">
                <img src="/static/images/1.png" id="dice1" style="position: absolute; top: 60%; left: 45%; width: 5%; height: 5%">
                <img src="/static/images/6.png" id="dice2" style="position: absolute; top: 60%; left: 50%; width: 5%; height: 5%">
            {% endif %}
        {% endfor %}
        
        <button style="position: absolute; top: 35%; left: 35%; width: 13%; height: 4%; opacity: 1;">Close</button>
        <button style="position: absolute; top: 35%; left: 52%; width: 13%; height: 4%; opacity: 1;">Ready</button>

        <button style="position: absolute; top: 52%; left: 35%; width: 8%; height: 3%; opacity: 1;">Roll</button>
        <button style="position: absolute; top: 57%; left: 35%; width: 8%; height: 3%; opacity: 1;">Buy</button>
        <button style="position: absolute; top: 62%; left: 35%; width: 8%; height: 3%; opacity: 1;">Upgrade</button>
        <button style="position: absolute; top: 52%; left: 57%; width: 8%; height: 3%; opacity: 1;">Pick</button>
        <button style="position: absolute; top: 57%; left: 57%; width: 8%; height: 3%; opacity: 1;">Teleport</button>
        <button style="position: absolute; top: 62%; left: 57%; width: 8%; height: 3%; opacity: 1;">End</button>
          
    </div>
    <div class="infos">
        <div class="logs">
            <div class="gamelog">
                <div>
                {% for line in game_log %}
                    <p> {{ line }} </p>
                {% endfor %}
                </div>
            </div>
            <div class="gamelog">
                <div>
                {% for line in error_log %}
                    <p> {{ line.0 }} </p>
                {% endfor %}
                </div>
            </div>

        </div>
        <div class="users">
            {% for user in board_status.users %}
            <div class="user">
                <p> <b>Username:</b> {{ user.username }} </p>
        
                <p> <b>Properties:</b> </p>
                
                <div class= "props"> 
                {% for property in user.properties %}
                    <div class="prop" style= "background-color: {{property.color}}; "> 
                        {{property.number}}) {{ property.name }}: Level {{property.level}} <br>
                        {{ property.rents }} <br>
                    </div>
                {% endfor %}
                </div>
               
                <p> <b>Location:</b> {{ user.location }} </p>
                <p> <b>Money:</b> {{ user.money }} </p>
                <p> <b>Ready:</b> {{ user.ready }} </p>
                <p> <b>Turn:</b> {{ user.isplaying }} </p>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<script type="text/javascript">
    class Ws {
        constructor(ipport) {
            this.socket = undefined;
            this.ipport = ipport;
            this.createwebsocket();
        }
        createwebsocket() {
            var socket = new WebSocket('ws://' + this.ipport);
            socket.onopen = function() {
                console.log('Connected')
                socket.send('{{username}} gamelog')
                setInterval(function(){
                    socket.send('{{username}} gamelog')
                }, 3000)
            }
            socket.onerror = function() {
                console.log('Connection failed')
            }
            socket.onclose = function() {
                console.log('Connection closed')
            }
            socket.onmessage = function(event) {
                console.log('Message received')
                console.log(JSON.parse(event.data))
            }
        }
    }

    window.onload = function () {
        ws = new Ws('127.0.0.1:1234')
    }

    const pickButtonHandler = (id) => {
        return (event) => {
            console.log(id);
            document.querySelector('#id_command_argument').value = id;
        };
    }
</script>

{% endblock %}